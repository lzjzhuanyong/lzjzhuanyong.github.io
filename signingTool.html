<!DOCTYPE html>
<html>
<head>
    <meta charset="uft-8">
    <script src="forge.min.js"></script>
    <style>
        html,body {height: 99%}
        div.root {display:grid; height: 100%;grid-template-rows: 54% 1% 39%;}
        div.upper {display:grid; grid-template-columns: 54% 1% 39%;}
        

        h1 {margin: 16px 0px 8px 8px;}
        h4 {margin: 16px 0px 0px 8px;}

        hr.middleline {border: 1px solid lightgrey; background-color: lightgrey;}
        hr.upper {height: 95%;width: 2px;border:none}
        hr.root {width: 93%;height:2px;margin:8px 0px 0px 8px;border:none}

        div.baseurl {margin: 16px 0px 0px 8px;display:inline-block;}
        div.path {display:inline-block}
        input#baseurl {width: 65%; padding: 8px 8px; margin: 8px 0px 0px 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; outline:none}
        input#path {width: 65%; padding: 8px 8px; margin: 8px 0px 0px 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; outline:none}

        p.example {margin: 8px 0px 0px 8px;font-size: 14px;}

        textarea#customized {width: 95%; height:20%; padding: 12px 8px; margin: 8px 0px 0px 8px; display:inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: none; outline:none}

        div.recvWindow {margin: 0px 0px 0px 8px;display:inline-block;}
        div.timestamp {display:inline-block;}
        input#recvWindow {width: 50%; padding: 8px 8px; margin: 8px 0px 0px 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; outline:none}
        input#timestamp {width: 50%; padding: 8px 8px; margin: 8px 0px 0px 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; outline:none}

        button#sign_button {width: 15%; height: 10%; padding: 5px 10px; margin: 8px 8px 1px 8px; border: 1px outset #ccc; border-radius: 4px; cursor: pointer; background-color: lightgrey; outline: none;}
        button#sign_button:hover {background-color: #B8B8B8; border: 1px outset #ccc; border-radius: 4px;}
        button#sign_button:active {box-shadow:0px 0px 0px 2px #ccc; background-color: #B8B8B8; border: 1px inset #ccc; border-radius: 4px;}
        
        h4.secretKey {display:inline-block}
        select#keyFormat {display:inline-block;padding: 8px 16px; margin: 16px 16px 1px 16px; border: 1px solid #ccc; border-radius: 4px; cursor: auto;}

        div.areaSecKey {height:80%}
        textarea#secretKey {width: 95%; height:95%; padding: 12px 8px; margin: 8px 0px 0px 8px; display:inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: none; outline:none}

        input#signature {width: 93%; padding: 8px 8px; margin: 8px 0px 0px 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; outline:none}

        div.requesturl {height:30%;}
        textarea#requesturl {width: 93%; height:80%; padding: 12px 8px; margin: 8px 0px 0px 8px; display:inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: none; outline:none}

        button#copytRequest {width: 10%; height: 10%; padding: 5px 10px; margin: 4px 8px 1px 8px; border: 1px outset #ccc; border-radius: 4px; cursor: pointer; background-color: lightgrey; outline: none;}
        button#copytRequest:hover {background-color: #B8B8B8; border: 1px outset #ccc; border-radius: 4px;}
        button#copytRequest:active {box-shadow:0px 0px 0px 2px #ccc; background-color: #B8B8B8; border: 1px inset #ccc; border-radius: 4px;}
        span.copytRequest {background-color:black;color:white;visibility: hidden;}
    </style>
</head>
<body>
    <div class="root">
        <div class="upper">
            <div class="left">
                <h1>Signature Tool</h1>
                <div>
                    <div class="baseurl">
                        base url: <input type='text' id="baseurl" value="https://api.binance.com/">
                    </div>
                    <div class="path">
                        path: <input type='text' id="path" value="api/v3/order">
                    </div>
                </div>
                <div>
                    <div>
                        <h4>Customized the querystring:</4>
                    </div>
                    <div>
                        <p class="example">symbol=BTCUSDT&side=BUY&type=LIMIT&quantity=1&price=300&newOrderRespType=FULL</p>
                    </div>
                    <div>
                        <textarea id='customized'>symbol=BTCUSDT&side=BUY&type=LIMIT&quantity=1&price=300&newOrderRespType=FULL</textarea>
                    </div>
                </div>
                <div>
                    <div class="recvWindow">
                        <input type="checkbox" name="recvWindow" checked="true">recvWindow: <input type='text' id="recvWindow" value=60000>
                    </div>
                    <div class="timestamp">
                        <input type="checkbox" name="timestamp" checked="true">timestamp: <input type="text" id='timestamp'>      
                    </div>
                    
                </div>
                <div>

                    <button id='sign_button' type="button">Sign Query</button>
                </div>
                
            </div>
            <hr class="upper middleline">
            <div class="right">
                <div>
                    <h4 class="secretKey">Secret Key/Private Key:</h4> 
                    <select id="keyFormat">
                        <option value="HMAC">HMAC Key</option>
                        <option value="RSA">RSA Key</option>
                    </select>
                </div>
                <div class="areaSecKey">
                    <textarea id='secretKey'></textarea>
                </div>
            </div>
        </div>
        <hr class="root middleline">
        <div class="lower">
            <div>
                <h4>Signature:</h4> 
                <input type='text' id='signature'>
            </div>
            
            <h4>Request URL:</h4> 
            <div class="requesturl">
                <textarea id='requesturl'></textarea>
            </div>
            <div class="copytRequest">
                <button id="copytRequest" type="button">Copy Request</button>
                <span class="copytRequest">Copied</span>
            </div>
        </div>
    </div>
</body>

<script type='text/javascript'>

        const hmac = forge.hmac.create();
        const pki = forge.pki;


        //url and path
        let baseurl = document.querySelector("#baseurl");
        let path = document.querySelector("#path");
        let sign_button = document.querySelector('#sign_button');

        //most querystring needed
        let recvWindow = document.querySelector("#recvWindow");
        let timestamp = document.querySelector('#timestamp');

        //customized querystring
        let customized = document.querySelector("#customized");

        //secretKey to generate the signature (HMAC SHA256)
        let secretKey = document.querySelector('#secretKey');

        //calculation start
        let data = {};

        let signature = document.querySelector('#signature');

        let requesturl = document.querySelector("#requesturl");

        let keyFormat = document.querySelector("select#keyFormat");

       


        keyFormat.addEventListener("change",()=>{
            console.log(keyFormat.value);
        })


        sign_button.addEventListener('click',()=>{

            if(document.querySelector("[name='recvWindow']").checked)
                    data.recvWindow = recvWindow.value;
                
            if(document.querySelector("[name='timestamp']").checked)
                data.timestamp = timestamp.value;

            let queryparameter = '';

            if(customized.value){
                queryparameter = customized.value + "&";
                console.log(customized.value)
                for(let parameter in data){
                    if(data[parameter])
                        queryparameter = queryparameter+parameter+'='+data[parameter]+"&";
                }
            }

            else{
                for(let parameter in data){
                    if(data[parameter])
                        queryparameter = queryparameter+parameter+'='+data[parameter]+"&";
                }
            }
                
            queryparameter = queryparameter.substr(0,queryparameter.length-1);
            console.log(queryparameter)

            if(keyFormat.value === "HMAC"){
                
                //console.log(secretKey.value)
                //console.log(secretKey.value.replace(/[\s]+$/g,''))
                
                //eliminate the space and line break character with regex
                hmac.start('sha256',secretKey.value.replace(/[\s]+$/g,''));
                hmac.update(queryparameter);
                signature.value = hmac.digest().toHex();

                let querystring = queryparameter+"&"+"signature="+signature.value;
                requesturl.value = baseurl.value+path.value+'?'+querystring;
            }
            else if(keyFormat.value === "RSA"){
                try{
                    let privateKey = pki.privateKeyFromPem(secretKey.value);
                    let md = forge.md.sha256.create();
                    md.update(queryparameter,"utf8");
                    
                    signature.value = encodeURIComponent(btoa(privateKey.sign(md)));
                    
                    let querystring = queryparameter+"&"+"signature="+signature.value;
                    requesturl.value = baseurl.value+path.value+'?'+querystring;
                }
                catch(error){
                    signature.value = "Please enter the correct RSA private key!";
                    console.log(error);
                }
            }
        })


        let recvWindowName = document.querySelector("[name='recvWindow']");
            recvWindowName.addEventListener("click",()=>{
                console.log(recvWindowName.checked)
                if(recvWindowName.checked)
                    data.recvWindow = recvWindow.value;
                else
                    delete data.recvWindow;
            })
                
        let timestampName = document.querySelector("[name='timestamp']");
        timestampName.addEventListener("click",()=>{
                
                if(timestampName.checked)
                    data.timestamp = timestamp.value;
                else 
                    delete data.timestamp;
            })
        
</script>

<script id="copyRequestUrl" type="text/javascript">

    let copytRequest = document.querySelector("button#copytRequest");
    
    copytRequest.addEventListener("click", ()=>{
        
        navigator.clipboard.writeText(requesturl.value).then(()=>{
            let span_message = document.querySelector("span.copytRequest");
            span_message.style="visibility:visible";
            setTimeout(function(){span_message.style="visibility:hidden"},800);
        })
    })

</script>

<script id="timestampRunningFunction" type='text/javascript'>

        let int = setInterval(()=>{
            timestamp.value = Date.now();
        },10)

        //control the timestamp, if timeStop is true, then timestamp can move on at present time; if timeStop is false, timestamp will stop. 
        let timeStop = false; 
        
        timestamp.addEventListener('mouseenter',()=>{
            timestamp.value = Date.now();
            clearInterval(int);
            //console.log("enter:",timeStop)
        })
        
        timestamp.addEventListener('mouseout',()=>{
            if(timeStop){
                //console.log("out1:",timeStop)
            }
            else{
                int = setInterval(()=>{
                            timestamp.value = Date.now();
                        },10)
               //console.log("out2:",timeStop)
            }
            
        })

        timestamp.addEventListener('focus',()=>{
            timeStop=true;
            //console.log("focus:",timeStop)
        })

        timestamp.addEventListener('blur',()=>{
            timeStop=false;
            //console.log("blur:",timeStop)
        })
</script>

</html>
