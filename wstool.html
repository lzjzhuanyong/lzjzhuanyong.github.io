<html>
    <head>
        <meta charset='utf-8'>
        <style>
            body
            {
               /*background-color: #e0e0e0; */
            }
            #output 
            {
                width:1000px;
                padding:2px;
                border:2px solid #afaeb0;
                margin:1px;
                height:250px;
                overflow:auto;
            }
            p.px480
            {
                width:480px;
            }
        </style>

       <!-- <script src="pako.min.js"></script> -->
    </head>
    <body>
        <h1>websocket test tool</h1>
        <P>    
            WSURL: <input type='text' id='wsurl' size=70 value="wss://stream.binance.com:9443/stream">
        </P>
        <p>
            <button id='button_link'>link</button>
            <button id='button_close'>close</button>
        </p>
        <p>
            message:
            
        </p>
        <p>
            <textarea id='message' cols=100 rows=5 style='resize:none'>
                {"method": "SUBSCRIBE","params":["btcusdt@aggTrade","btcusdt@depth"],"id": 1}
            </textarea>
        </p>
        <p>
            <button id="button_send">send</button>
        </p>
        <p>
            DATA: <button id="button_ungzip" title="For unziping gzip data">unzip</button>
        </p>
        <P>
            <style>
                .bubble{
                    word-wrap: break-word;
                }
            </style>
            <div id="output">
              
                
            </div>
            <!--<textarea id='wsdata' cols=150 rows=20 style='resize:none'></textarea>-->
        </P>

    </body>

    <script type='text/javascript'>

        let wsurl = document.querySelector('#wsurl');
        let button_link = document.querySelector('#button_link');
        let button_close = document.querySelector('#button_close');
        let button_send = document.querySelector('#button_send');
        let message= document.querySelector('#message');
        //let wsdata = document.querySelector('#wsdata');
        let output = document.querySelector("#output");

        let button_ungzip = document.querySelector("#button_ungzip");
        let raw = true;
        //let data = {};
        //let i = 0;


        button_link.addEventListener('click',()=>{
            const binancewss = new WebSocket(wsurl.value);
            
            //let connect = setInterval(
            //()=>{
            switch(binancewss.readyState){
                case 0:  
                    //wsdata.value = wsdata.value + 'linking' + '\n' + "……" + '\n';

                    insertMessage(Date.now(),"linking……");

                    console.log(binancewss.readyState);
                    console.log("Socket has been created. The connection is not yet open.");
                    break;

                case 1:
                //clearInterval(connect);
                    console.log(binancewss.readyState);
                    console.log("The connection is open and ready to communicate.");
                    break;

                case 2:
                    console.log(binancewss.readyState);
                    console.log("The connection is in the process of closing.");
                    break;

                case 3:
                    console.log(binancewss.readyState);
                    console.log("The connection is closed or couldn't be opened.");
                    break;
            }
            //},1000)
            
            
            //console.log(binancewss.readyState)
            binancewss.addEventListener('open',event=>{
                //wsdata.value = wsdata.value + 'linked' + '\n' + "……" + '\n';

                insertMessage(Date.now(),"linked……");

                console.log(binancewss.readyState);
                console.log("The connection is open and ready to communicate.");
            })

            binancewss.addEventListener('close',event=>{
                //wsdata.value = wsdata.value + 'closed' + '\n' + "……" + '\n';

                insertMessage(Date.now(),"closed……");
                console.log(binancewss.readyState);
                console.log("The connection is closed or couldn't be opened.");
            })
            
            binancewss.addEventListener('message',event=>{
                    //console.log(typeof event.data);
                    //console.log(event)

                    let ifDataIsBlob = event.data instanceof Blob;
                    //console.log(ifDataIsBlob);
                    //console.log(event.data instanceof Blob);
                    let text = JSON.stringify(event.data);
                    switch(raw){
                        case true:
                            insertMessage(Date.now(),event.data);
                            break;
                        case false:
                            if(ifDataIsBlob){
                                let a = unzip(event.data);
                                //console.log(a);
                            }
                            else{
                                insertMessage(Date.now(),"no need to unzip the data!");
                                insertMessage(Date.now(),event.data);
                                
                                raw = true;
                                button_ungzip.innerHTML = "unzip";
                            }
                            break;
                    }
                    
                    
                    //console.log(event.data)
                    

                    //console.log(text)

                    //自动滚动到最后一行
                    output.scrollTop = output.scrollHeight;
                    console.log(output.scrollHeight)
                })
            
            
            //wa = JSON.stringify(message.value);
            //console.log(wa)
            button_send.addEventListener('click',()=>{
                console.log(message.value)
                wa = JSON.parse(message.value);
                wa = JSON.stringify(wa);
                console.log(wa)
                binancewss.send(wa);
            })

            button_close.addEventListener('click', ()=>{
                
                if(binancewss.readyState !== 3){
                    binancewss.close();
                }

                if(binancewss.readyState === 2){
                    //wsdata.value = wsdata.value + 'closing' + '\n' + "……" + '\n';
                    insertMessage(Date.now(),"closing……");
                    console.log(binancewss.readyState);
                    console.log("The connection is in the process of closing.");
                }
                //监听器监听websocket是否完全关闭
                /*
                binancewss.addEventListener('close',()=>{
                    wsdata.value = wsdata.value + "链接断开" + '\n' ;
                    console.log(binancewss.readyState);
                    console.log("The connection is closed or couldn't be opened.");
                })
                */
                //console.log(i++);
                

                //console.log(wsdata.value)
               
            })

            
        })

        button_ungzip.addEventListener('click',()=>{
            if(raw){
                raw = false;
                button_ungzip.innerHTML = "zip";
            }
            else{
                raw = true;
                button_ungzip.innerHTML = "unzip";
            }
        })

       /*
        const binancewss = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@miniTicker');
        let connect = setInterval(
            ()=>{
                if(binancewss.readyState === 0){
                    console.log('正在链接中');
                    }
                else{
                    clearInterval(connect);
                }
            },1000)
            binancewss.addEventListener('open',event=>{
                binancewss.send();
                console.log(binancewss.readyState)
            })
            binancewss.addEventListener('message',event=>{
            console.log(event)
            //wsdata.value = wsdata.value + '\n' + event.data;
            })
        */
        
        
            
        
       

       // let ws= new WebSocket()
    </script>
    <script type='text/javascript'>

        function insertMessage(...args){

                //console.log(args);
                let text = "";
                for(let val of args){
                    text += val + " ";
                }

                let paragraph = document.createElement('p');
                
                paragraph.setAttribute("class","bubble");
                let message = document.createTextNode(text);

                paragraph.appendChild(message);
                output.appendChild(paragraph);
            }

        
        function unzip(data){
            
            data.text().then(function(resolve,reject){
                let result = resolve;
                //console.log(typeof(result));
                insertMessage(Date.now(),result);
            })
            /*
            let reader = new FileReader();
            reader.readAsArrayBuffer(data);
            reader.addEventListener("loadend", function() {
                //console.log(reader.result);
                let result = pako.ungzip(reader.result,{to:'string'});
                //console.log(result);
                insertMessage(Date.now(),result);
                // reader.result 包含被转化为类型数组 typed array 的 blob
            });
            */
        }
    </script>
</html>
